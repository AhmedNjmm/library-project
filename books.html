
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ - Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</title>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDJq89s9gs3lGKj1eKM0eDD0Mein6mmm50",
      authDomain: "library-project-f63b0.firebaseapp.com",
      projectId: "library-project-f63b0",
      storageBucket: "library-project-f63b0.appspot.com",
      messagingSenderId: "91581535655",
      appId: "1:91581535655:web:380c1e059ab48008855282"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-md bg-primary navbar-dark py-3">
    <div class="container">
      <a class="navbar-brand" href="index.html">ğŸ“š Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</a>
      <div class="collapse navbar-collapse" id="navcol-1">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li class="nav-item"><a class="nav-link active" href="books.html">Ø§Ù„ÙƒØªØ¨</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li class="nav-item"><a class="btn btn-success ms-2" href="login.html">ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <h1 class="text-center">ğŸ“š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨</h1>
    <div class="d-flex flex-wrap gap-2 justify-content-center mb-3" id="category-filters">
      <button class="btn btn-outline-primary filter-btn" data-category="All">Ø§Ù„ÙƒÙ„</button>
    </div>
    <form id="search-form" class="mb-3">
      <div class="input-group">
        <input type="text" class="form-control" id="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨">
        <button class="btn btn-outline-secondary" type="submit">Ø¨Ø­Ø«</button>
      </div>
    </form>
    <div class="row row-cols-1 row-cols-md-3 g-4" id="books-row"></div>
    <p class="text-center text-muted mt-4" id="no-books" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ</p>
  </div>

  <script>
    const booksRow = document.getElementById("books-row");
    const noBooksMsg = document.getElementById("no-books");
    const searchForm = document.getElementById("search-form");
    const searchInput = document.getElementById("search-input");
    const categoryFilters = document.getElementById("category-filters");

    let allBooks = [];

    function renderBooks(books) {
      booksRow.innerHTML = "";
      if (books.length === 0) {
        noBooksMsg.style.display = "block";
        return;
      }
      noBooksMsg.style.display = "none";

      const email = localStorage.getItem("userEmail");

      books.forEach(book => {
        const col = document.createElement("div");
        col.className = "col";

        const borrowButton = email
          ? `<button class="btn btn-success mt-2" onclick="borrowFromCard('${book.id}', '${book.title}')">ğŸ“š Ø§Ø³ØªØ¹Ø§Ø±Ø©</button>`
          : `<button class="btn btn-secondary mt-2" onclick="alert('ğŸš« ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!')">ğŸ“š ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©</button>`;

        col.innerHTML = `
          <div class="card h-100">
            <img src="${book.image}" class="card-img-top" alt="...">
            <div class="card-body">
              <h5 class="card-title">${book.title}</h5>
              <p class="card-text">${book.description.substring(0, 100)}...</p>
              <p><span class="badge bg-info">${book.category}</span></p>
              <a href="book-details.html?id=${book.id}" class="btn btn-primary w-100">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
              ${borrowButton}
            </div>
          </div>
        `;
        booksRow.appendChild(col);
      });
    }

    function fetchBooks() {
      db.collection("books").get()
        .then(snapshot => {
          allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          renderBooks(allBooks);
          renderCategories([...new Set(allBooks.map(b => b.category))]);
        });
    }

    function renderCategories(categories) {
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.className = "btn btn-outline-secondary filter-btn";
        btn.textContent = cat;
        btn.dataset.category = cat;
        categoryFilters.appendChild(btn);
      });
    }

    categoryFilters.addEventListener("click", function (e) {
      if (e.target.classList.contains("filter-btn")) {
        const selected = e.target.dataset.category;
        if (selected === "All") {
          renderBooks(allBooks);
        } else {
          renderBooks(allBooks.filter(b => b.category === selected));
        }
      }
    });

    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const query = searchInput.value.trim().toLowerCase();
      const results = allBooks.filter(b => b.title.toLowerCase().includes(query));
      renderBooks(results);
    });

    fetchBooks();

    async function borrowFromCard(bookId, bookTitle) {
      const userEmail = localStorage.getItem("userEmail");
      if (!userEmail) {
        alert("ğŸš« ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹!");
        return;
      }

      const bookRef = db.collection("books").doc(bookId);
      const bookSnap = await bookRef.get();

      if (!bookSnap.exists) return alert("âŒ Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      const book = bookSnap.data();

      if (book.available <= 0) return alert("ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ù…ØªØ§Ø­Ø©.");

      const borrowSnap = await db.collection("borrows")
        .where("user", "==", userEmail)
        .where("bookTitle", "==", bookTitle)
        .get();

      if (!borrowSnap.empty) return alert("ğŸ“š Ù„Ù‚Ø¯ Ø§Ø³ØªØ¹Ø±Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹.");

      const now = new Date();
      const date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

      await db.collection("borrows").add({
        user: userEmail,
        bookTitle: bookTitle,
        date: date
      });

      await bookRef.update({ available: book.available - 1 });

      alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø§Ù„ÙƒØªØ§Ø¨!");
      fetchBooks();
    }
  </script>
  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>
