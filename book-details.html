<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“– ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨</title>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDJq89s9gs3lGKj1eKM0eDD0Mein6mmm50",
      authDomain: "library-project-f63b0.firebaseapp.com",
      projectId: "library-project-f63b0",
      storageBucket: "library-project-f63b0.appspot.com",
      messagingSenderId: "91581535655",
      appId: "1:91581535655:web:380c1e059ab48008855282"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="row">
      <div class="col-md-6">
        <img id="book-image" class="img-fluid rounded shadow" alt="ØºÙ„Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨" />
      </div>
      <div class="col-md-6">
        <h2 id="book-title"></h2>
        <p id="book-description" class="mt-3"></p>
        <p id="book-available" class="text-muted"></p>
        <button id="borrow-btn" class="btn btn-success w-100 mt-3">ğŸ“š Ø§Ø³ØªØ¹Ø§Ø±Ø©</button>
        <button id="return-btn" class="btn btn-danger w-100 mt-2 d-none">ğŸ” Ø¥Ø±Ø¬Ø§Ø¹</button>
        <a href="books.html" class="btn btn-outline-secondary w-100 mt-3">ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©</a>
      </div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    const params = new URLSearchParams(window.location.search);
    const bookId = params.get("id");

    let currentUser;
    let bookData;

    firebase.auth().onAuthStateChanged(async user => {
      if (!bookId) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨.");

      // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
      if (!user) {
        document.getElementById("borrow-btn").addEventListener("click", () => {
          alert("â— ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø±Ø©.");
          window.location.href = "login.html";
        });
        return;
      }

      currentUser = user;

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨
      const doc = await db.collection("books").doc(bookId).get();
      if (!doc.exists) return alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

      bookData = doc.data();
      document.getElementById("book-title").textContent = bookData.title;
      document.getElementById("book-image").src = bookData.image;
      document.getElementById("book-description").textContent = bookData.description || "ğŸ“– Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ.";
      document.getElementById("book-available").textContent = `ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ØªØ§Ø­Ø©: ${bookData.available}`;

      const borrowBtn = document.getElementById("borrow-btn");
      const returnBtn = document.getElementById("return-btn");

      const borrowQuery = await db.collection("borrows")
        .where("user", "==", user.email)
        .where("bookTitle", "==", bookData.title)
        .get();

      const alreadyBorrowed = !borrowQuery.empty;

      if (alreadyBorrowed) {
        borrowBtn.classList.add("d-none");
        returnBtn.classList.remove("d-none");
      } else if (bookData.available <= 0) {
        borrowBtn.disabled = true;
        borrowBtn.textContent = "ğŸš« ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹";
        borrowBtn.classList.replace("btn-success", "btn-secondary");
      }

      borrowBtn.addEventListener("click", async () => {
        const now = new Date();
        const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;

        await db.collection("borrows").add({
          user: user.email,
          bookTitle: bookData.title,
          date: formattedDate
        });

        await db.collection("books").doc(bookId).update({
          available: bookData.available - 1
        });

        alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø±Ø© Ø§Ù„ÙƒØªØ§Ø¨!");
        location.reload();
      });

      returnBtn.addEventListener("click", async () => {
        const borrowDoc = borrowQuery.docs[0];
        await db.collection("borrows").doc(borrowDoc.id).delete();
        await db.collection("books").doc(bookId).update({
          available: bookData.available + 1
        });

        alert("ğŸ” ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙƒØªØ§Ø¨!");
        location.reload();
      });
    });
  </script>

  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>
