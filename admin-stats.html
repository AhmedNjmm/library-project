<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>๐ ุฅุญุตุงุฆูุงุช ุงููุดุฑู</title>
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="admin.html">๐ ููุญุฉ ุชุญูู ุงูุฃุฏูู</a>
    </div>
  </nav>

  <div class="container">
    <h1 class="text-center mb-4">๐ ููุญุฉ ุงูุฅุญุตุงุฆูุงุช ูุงูุงุณุชุนุงุฑุงุช</h1>

    <div id="stats-summary" class="row text-center mb-4">
      <div class="col-md-4"><div class="card p-3"><h4>๐ ุนุฏุฏ ุงููุชุจ</h4><p id="total-books">...</p></div></div>
      <div class="col-md-4"><div class="card p-3"><h4>๐ ุนุฏุฏ ุงูุชุตูููุงุช</h4><p id="total-categories">...</p></div></div>
      <div class="col-md-4"><div class="card p-3"><h4>๐ฅ ุนุฏุฏ ุงููุณุชุฎุฏููู</h4><p id="total-users">...</p></div></div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6 mb-2">
        <input type="text" id="filter-email" class="form-control" placeholder="๐ ููุชุฑุฉ ุญุณุจ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
      </div>
      <div class="col-md-6">
        <input type="date" id="filter-date" class="form-control">
      </div>
    </div>

    <h3 class="mb-3">๐ ูุงุฆูุฉ ุงูุงุณุชุนุงุฑุงุช</h3>
    <div class="table-responsive">
      <table class="table table-bordered" id="borrows-table">
        <thead>
          <tr>
            <th>๐ง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
            <th>๐ ุงุณู ุงููุชุงุจ</th>
            <th>๐ ุชุงุฑูุฎ ุงูุงุณุชุนุงุฑุฉ</th>
          </tr>
        </thead>
        <tbody id="borrow-log-body"></tbody>
      </table>
    </div>

    <div class="text-center my-4">
      <button class="btn btn-success me-2" onclick="exportToExcel()">๐ ุชุตุฏูุฑ Excel</button>
      <button class="btn btn-danger" onclick="exportToPDF()">๐ ุชุตุฏูุฑ PDF</button>
    </div>
  </div>

  <script>
    const db = firebase.firestore();
    let borrowData = [];

    firebase.auth().onAuthStateChanged(async user => {
      if (!user || user.email !== "admin@library.com") {
        window.location.replace("unauthorized.html");
        return;
      }

      const booksCount = await db.collection("books").get().then(snap => snap.size);
      const catsCount = await db.collection("categories").get().then(snap => snap.size);
      const borrowsSnap = await db.collection("borrows").get();
      const users = new Set();

      document.getElementById("total-books").textContent = booksCount;
      document.getElementById("total-categories").textContent = catsCount;

      const tbody = document.getElementById("borrow-log-body");
      tbody.innerHTML = "";
      borrowData = [];

      borrowsSnap.forEach(doc => {
        const b = doc.data();
        users.add(b.user);
        borrowData.push({ user: b.user, title: b.bookTitle, date: b.date });
      });
      document.getElementById("total-users").textContent = users.size;
      renderTable();
    });

    function renderTable() {
      const tbody = document.getElementById("borrow-log-body");
      const emailFilter = document.getElementById("filter-email").value.toLowerCase();
      const dateFilter = document.getElementById("filter-date").value;
      tbody.innerHTML = "";

      borrowData.forEach(entry => {
        if (
          (!emailFilter || entry.user.toLowerCase().includes(emailFilter)) &&
          (!dateFilter || entry.date === dateFilter)
        ) {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${entry.user}</td><td>${entry.title}</td><td>${entry.date}</td>`;
          tbody.appendChild(row);
        }
      });
    }

    document.getElementById("filter-email").addEventListener("input", renderTable);
    document.getElementById("filter-date").addEventListener("change", renderTable);

    function exportToExcel() {
      const visibleRows = Array.from(document.querySelectorAll("#borrow-log-body tr")).map(row => {
        return Array.from(row.children).map(cell => cell.textContent);
      });
      const ws = XLSX.utils.aoa_to_sheet([["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู", "ุงุณู ุงููุชุงุจ", "ุชุงุฑูุฎ ุงูุงุณุชุนุงุฑุฉ"], ...visibleRows]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Borrow Log");
      XLSX.writeFile(wb, "borrow-log.xlsx");
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("๐ ุณุฌู ุงูุงุณุชุนุงุฑุงุช", 10, 10);

      const visibleRows = Array.from(document.querySelectorAll("#borrow-log-body tr")).map(row => {
        return Array.from(row.children).map(cell => cell.textContent);
      });

      doc.autoTable({
        head: [["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู", "ุงุณู ุงููุชุงุจ", "ุชุงุฑูุฎ ุงูุงุณุชุนุงุฑุฉ"]],
        body: visibleRows,
        startY: 20,
        styles: { font: "helvetica", fontSize: 10 }
      });

      doc.save("borrow-log.pdf");
    }
  </script>

  <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>
